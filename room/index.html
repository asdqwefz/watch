<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create or Join Room - Watch4Party Premium</title>
    <link rel="canonical" href="https://watch4party.com/room">
    <link rel="icon" type="image/png" href="../img/hero-logo.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
</head>

<body>
    <div class="auth-container">
        <div class="auth-card">
            <h2 class="auth-title" id="room-title">Enter Room</h2>
            <p class="auth-subtitle" id="room-subtitle">Join the watch party as a guest</p>

            <!-- Join: room code -->
            <div id="join-code-group" class="form-group" style="display: none;">
                <label class="form-label" for="room-code">Room Code</label>
                <input type="text" id="room-code" class="form-input" placeholder="e.g. ABC123" maxlength="6"
                    autocomplete="off" style="text-transform: uppercase; letter-spacing: 0.2em;">
            </div>

            <div id="guest-form">
                <div class="form-group">
                    <label class="form-label" for="guest-name">Display Name</label>
                    <input type="text" id="guest-name" class="form-input" placeholder="Guest_123">
                </div>

                <div class="form-group">
                    <label class="form-label">Choose Avatar</label>
                    <div class="avatar-grid"
                        style="display: flex; gap: 10px; justify-content: center; margin-bottom: 1rem;">
                        <!-- Avatars injected by JS -->
                    </div>
                </div>
                <style>
                    .avatar-option {
                        width: 45px;
                        height: 45px;
                        border-radius: 50%;
                        border: 2px solid var(--card-border);
                        cursor: pointer;
                        transition: all 0.2s;
                        opacity: 0.7;
                    }
                    .avatar-option:hover {
                        transform: scale(1.1);
                        opacity: 1;
                    }
                    .avatar-option.selected {
                        border-color: var(--accent-red);
                        opacity: 1;
                        box-shadow: 0 0 10px rgba(229, 9, 20, 0.4);
                        transform: scale(1.1);
                    }
                </style>
                <button id="btn-submit" class="btn btn-primary" style="width: 100%;">Continue as Guest</button>
            </div>

            <div class="auth-footer" style="margin-top: 1rem;">
                <a href="../index.html" style="color: var(--text-secondary); font-size: 0.8rem;">
                    <i class="fa-solid fa-arrow-left"></i> Back to Home
                </a>
                <span id="switch-mode-link" style="margin-left: 1rem;"></span>
            </div>
        </div>
    </div>

    <!-- Error modal (room not found / invalid) -->
    <div id="errorModal" class="modal-overlay" style="display: none; opacity: 0;">
        <div class="modal-content">
            <div class="modal-icon"
                style="background: rgba(229, 9, 20, 0.1); color: var(--accent-red); border-color: rgba(229, 9, 20, 0.3);">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h3 id="errorModalTitle">Room not found</h3>
            <p id="errorModalMessage">Please check the room code and try again.</p>
            <div class="modal-actions">
                <button class="btn btn-primary" id="btn-error-close">OK</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const STORAGE_KEY = 'watch4party_rooms';
            const AVATAR_SEEDS = ['Felix', 'Aneka', 'Zoe', 'Max', 'Luna'];
            const PLATFORM_ROOM_CODES = { 'K7M2N9': 1, 'R4T8V1': 1, 'X3Y6Z2': 1, 'A9B5C7': 1, 'D1E4F8': 1, 'G2H6J3': 1, 'L5P0Q9': 1 };

            function getRooms() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    return raw ? JSON.parse(raw) : {};
                } catch (_) { return {}; }
            }

            function setRooms(rooms) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
            }

            function generateCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
                return code;
            }

            function isCreateMode() {
                const params = new URLSearchParams(window.location.search);
                return params.get('create') === '1';
            }

            function initRoom() {
                const roomTitle = document.getElementById('room-title');
                const roomSubtitle = document.getElementById('room-subtitle');
                const joinCodeGroup = document.getElementById('join-code-group');
                const roomCodeInput = document.getElementById('room-code');
                const guestNameInput = document.getElementById('guest-name');
                const avatarGrid = document.querySelector('.avatar-grid');
                const btnSubmit = document.getElementById('btn-submit');
                const switchModeLink = document.getElementById('switch-mode-link');
                const errorModal = document.getElementById('errorModal');
                const errorModalTitle = document.getElementById('errorModalTitle');
                const errorModalMessage = document.getElementById('errorModalMessage');
                const btnErrorClose = document.getElementById('btn-error-close');

                if (!btnSubmit || !guestNameInput) return;

                let currentUser = null;
                try {
                    currentUser = JSON.parse(localStorage.getItem('watch4party_currentUser'));
                } catch (_) {}

                const createMode = isCreateMode();
                var joinParam = new URLSearchParams(window.location.search).get('join');
                if (!createMode && joinParam && roomCodeInput) {
                    roomCodeInput.value = (joinParam.trim().toUpperCase().replace(/[^A-Z0-9]/g, '')).slice(0, 6);
                }

                if (createMode) {
                    if (roomTitle) roomTitle.textContent = 'Create Room';
                    if (roomSubtitle) roomSubtitle.textContent = 'Set your display name and start a watch party';
                    if (joinCodeGroup) joinCodeGroup.style.display = 'none';
                    btnSubmit.textContent = 'Create Room';
                    if (switchModeLink) {
                        switchModeLink.innerHTML = '<a href="index.html" style="color: var(--accent-red); font-size: 0.8rem;">Join existing room</a>';
                    }
                } else {
                    if (roomTitle) roomTitle.textContent = 'Join Room';
                    if (roomSubtitle) roomSubtitle.textContent = currentUser && currentUser.username
                        ? 'Join the watch party as ' + currentUser.username
                        : 'Enter the room code and your display name';
                    if (joinCodeGroup) joinCodeGroup.style.display = 'block';
                    btnSubmit.textContent = (currentUser && currentUser.username) ? 'Join Room' : 'Continue as Guest';
                    if (switchModeLink) {
                        switchModeLink.innerHTML = '<a href="index.html?create=1" style="color: var(--accent-red); font-size: 0.8rem;">Create new room</a>';
                    }
                }

                if (currentUser && currentUser.username) {
                    guestNameInput.value = currentUser.username;
                    guestNameInput.placeholder = currentUser.username;
                }

                // Avatars
                let selectedAvatar = AVATAR_SEEDS[0];
                if (avatarGrid) {
                    avatarGrid.innerHTML = '';
                    AVATAR_SEEDS.forEach(function (seed, index) {
                        const img = document.createElement('img');
                        img.src = 'https://api.dicebear.com/9.x/avataaars/svg?seed=' + seed;
                        img.className = 'avatar-option' + (index === 0 ? ' selected' : '');
                        img.alt = seed;
                        img.onclick = function () {
                            document.querySelectorAll('.avatar-option').forEach(function (el) { el.classList.remove('selected'); });
                            img.classList.add('selected');
                            selectedAvatar = seed;
                        };
                        avatarGrid.appendChild(img);
                    });
                }

                function showError(title, message) {
                    if (errorModalTitle) errorModalTitle.textContent = title;
                    if (errorModalMessage) errorModalMessage.textContent = message;
                    if (errorModal) {
                        errorModal.style.display = 'flex';
                        errorModal.classList.add('active');
                        errorModal.style.opacity = '1';
                    }
                }

                if (btnErrorClose) {
                    btnErrorClose.addEventListener('click', function () {
                        if (errorModal) {
                            errorModal.style.display = 'none';
                            errorModal.style.opacity = '0';
                            errorModal.classList.remove('active');
                        }
                    });
                }
                if (errorModal) {
                    errorModal.addEventListener('click', function (e) {
                        if (e.target === errorModal) {
                            errorModal.style.display = 'none';
                            errorModal.style.opacity = '0';
                            errorModal.classList.remove('active');
                        }
                    });
                }

                btnSubmit.addEventListener('click', function () {
                    const name = (guestNameInput.value || '').trim();
                    if (!name) {
                        showError('Name required', 'Please enter a display name.');
                        return;
                    }

                    if (createMode) {
                        const rooms = getRooms();
                        let code = generateCode();
                        while (rooms[code]) code = generateCode();
                        rooms[code] = {
                            code: code,
                            hostName: name,
                            hostAvatar: selectedAvatar,
                            members: [{ name: name, avatar: selectedAvatar, isHost: true }],
                            createdAt: Date.now()
                        };
                        setRooms(rooms);
                        try { sessionStorage.setItem('watch4party_room_displayName', name); } catch (_) {}
                        // Watch page URL: room/watch/?code=... (room/watch/index.html)
                        window.location.href = 'watch/?code=' + encodeURIComponent(code);
                        return;
                    }

                    var rawCode = (roomCodeInput && roomCodeInput.value) ? roomCodeInput.value : '';
                    var codeInput = (rawCode.trim().toUpperCase().replace(/[^A-Z0-9]/g, '')).slice(0, 6);
                    if (!codeInput || codeInput.length !== 6) {
                        showError('Room code required', 'Please enter the 6-character room code (letters and numbers).');
                        return;
                    }

                    if (PLATFORM_ROOM_CODES[codeInput]) {
                        try { sessionStorage.setItem('watch4party_room_displayName', name); } catch (_) {}
                        window.location.href = 'watch/?code=' + encodeURIComponent(codeInput);
                        return;
                    }
                    const rooms = getRooms();
                    const room = rooms[codeInput];
                    if (!room || !room.members) {
                        showError('Room not found', 'No room with this code in this browser. Open "Create Room" in another tab first, create a room, then enter that code here (same browser only).');
                        return;
                    }

                    const alreadyIn = room.members.some(function (m) { return m.name === name; });
                    if (!alreadyIn) {
                        room.members.push({ name: name, avatar: selectedAvatar, isHost: false });
                        setRooms(rooms);
                    }
                    try { sessionStorage.setItem('watch4party_room_displayName', name); } catch (_) {}
                    // Watch page URL: room/watch/?code=...
                    window.location.href = 'watch/?code=' + encodeURIComponent(codeInput);
                });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initRoom);
            } else {
                initRoom();
            }
        })();
    </script>
</body>

</html>
